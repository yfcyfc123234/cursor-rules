---
alwaysApply: true
---

# 规则自动导入

> 定义规则自动导入的完整流程，整合 GitHub 拉取和本地缓存逻辑，支持自动检测和手动触发

## 触发机制

### 自动触发

- **打开项目时**：检测到 `.cursor/rules/` 目录不存在或为空时，自动提示用户是否导入规则
- **提示模式**：自动检测项目类型后，提示用户确认是否导入规则

### 手动触发

支持以下自然语言指令：

**导入规则**：
- "导入规则"
- "帮我导入规则"
- "导入安卓规则" / "导入 Android 规则"
- "导入 Flutter 规则"
- "导入 Python 规则"
- "导入 PHP 规则"
- "这是 Flutter 项目，导入规则"
- "这是一个 Android 项目"

**更新规则**：
- "更新规则"
- "同步规则"
- "刷新规则"
- "重新导入规则"
- "更新项目规则"
- 当规则项目数据发生变化时，使用这些指令更新当前项目的规则文件

### 触发检测逻辑

1. **检查 `.cursor/rules/` 目录**
   - 如果目录不存在或为空，进入自动触发流程（导入规则）
   - 如果目录已存在且不为空：
     - 用户说"更新规则"、"同步规则"等 → 执行更新流程（覆盖现有规则）
     - 用户说"导入规则" → 询问用户是否覆盖或更新

2. **识别用户指令**
   - **导入规则**：检测用户消息中是否包含"导入规则"、"导入 XXX 规则"等关键词
   - **更新规则**：检测用户消息中是否包含"更新规则"、"同步规则"、"刷新规则"等关键词
   - 检测用户是否明确指定项目类型

### 更新规则流程

当用户明确要求更新规则时：

1. **检测现有规则**
   - 检查 `.cursor/rules/` 目录中已存在的规则文件
   - 识别当前项目的项目类型

2. **重新拉取规则**
   - 从本地缓存或 GitHub 重新拉取最新的规则文件
   - 确保获取最新版本的规则

3. **覆盖现有规则**
   - 直接覆盖 `.cursor/rules/` 目录中的现有规则文件
   - 不询问用户确认（因为用户已明确要求更新）

4. **完成提示**
   - 显示已更新的规则文件列表
   - 提示用户规则已更新到最新版本

## 项目类型识别

### 自动检测

按以下优先级自动检测项目类型：

1. **Flutter 混合项目**
   - 检测条件：存在 `pubspec.yaml` 且存在 `android/` 目录
   - 规则文件：`android-flutter-project.mdc`

2. **Flutter 项目**
   - 检测条件：存在 `pubspec.yaml`
   - 规则文件：`flutter-project.mdc`

3. **Android 项目**
   - 检测条件：存在 `settings.gradle` 或根目录 `build.gradle`，且不存在 `pubspec.yaml`
   - 规则文件：`android-project.mdc`

4. **Python 项目**
   - 检测条件：存在 `requirements.txt` 或 `pyproject.toml`
   - 规则文件：`python-project.mdc`

5. **PHP 项目**
   - 检测条件：存在 `composer.json`
   - 规则文件：`php-project.mdc`

6. **Kotlin 项目**
   - 检测条件：主要代码文件为 `.kt` 文件
   - 规则文件：`kotlin-project.mdc`

7. **Java 项目**
   - 检测条件：主要代码文件为 `.java` 文件
   - 规则文件：`java-project.mdc`

### 用户指定

如果用户明确说明项目类型（如"这是 Flutter 项目"），优先使用用户指定的类型，忽略自动检测结果。

## 规则来源选择

### 优先级策略

1. **优先从本地缓存拉取**
   - 本地缓存路径：`C:\Users\Administrator\Desktop\cursor-rules`
   - 如果本地存在规则文件，直接使用本地文件

2. **GitHub 作为备用**
   - GitHub 仓库：`https://github.com/yfcyfc123234/cursor-rules`
   - 默认分支：`main`
   - Raw Content URL：`https://raw.githubusercontent.com/yfcyfc123234/cursor-rules/main/`
   - 如果本地不存在，从 GitHub 拉取

3. **自动更新缓存**
   - 从 GitHub 拉取成功后，自动更新本地缓存
   - 确保本地缓存与 GitHub 仓库同步

## 规则文件导入流程

### 步骤 1：拉取通用规则

从 `common-rules/` 目录拉取以下文件（排除 `github-rules-sync.mdc`）：

- `user-base-rule.mdc` - 用户基础规则
- `git-automation.mdc` - Git 自动化规则
- `auto-import-rules.mdc` - 规则自动导入规则（本文件）
- `ui-design-reconstruction.mdc` - UI 设计图还原规则
- `project-rules-auto-management.mdc` - 项目规则管理规则
- `batch-file-operations.mdc` - 批量文件操作优化规则

**排除文件**：`github-rules-sync.mdc`（避免循环拉取）

### 步骤 2：拉取项目规则

根据项目类型匹配对应的项目规则文件：

- Flutter 混合项目 → `android-flutter-project.mdc`
- Flutter 项目 → `flutter-project.mdc`
- Android 项目 → `android-project.mdc`
- Python 项目 → `python-project.mdc`
- PHP 项目 → `php-project.mdc`
- Kotlin 项目 → `kotlin-project.mdc`
- Java 项目 → `java-project.mdc`

### 步骤 3：验证文件格式

1. **检查 frontmatter**
   - 所有规则文件必须包含 frontmatter：
     ```markdown
     ---
     alwaysApply: true
     ---
     ```

2. **自动修复**
   - 如果文件缺少 frontmatter，自动添加
   - 确保文件格式正确

### 步骤 4：处理文件名冲突

1. **通用规则文件**
   - 保持原文件名（如 `user-base-rule.mdc`）

2. **项目规则文件**
   - 使用描述性名称，基于项目类型：
     - Flutter 混合项目 → `android-flutter-rules.mdc`
     - Flutter 项目 → `flutter-rules.mdc`
     - Android 项目 → `android-rules.mdc`
     - Python 项目 → `python-rules.mdc`
     - PHP 项目 → `php-rules.mdc`
     - Kotlin 项目 → `kotlin-rules.mdc`
     - Java 项目 → `java-rules.mdc`

3. **冲突处理**
   - 检查 `.cursor/rules/` 目录中是否已存在同名文件
   - 如果存在，使用递增后缀：
     - 如果已有 `android-rules.mdc`，使用 `android-rules2.mdc`
     - 如果已有 `android-rules.mdc` 和 `android-rules2.mdc`，使用 `android-rules3.mdc`
     - 依此类推

### 步骤 5：保存到项目

1. **创建目录**
   - 在项目根目录创建 `.cursor/rules/` 目录（如果不存在）

2. **保存文件**
   - 将所有成功拉取的文件保存到 `.cursor/rules/` 目录
   - 使用确定的文件名
   - 确保文件内容完整，包含 frontmatter

3. **验证保存结果**
   - 检查文件是否成功保存
   - 验证文件内容是否正确

### 步骤 6：完成提示

成功导入所有规则文件后，提示用户：

```
✅ 已成功导入规则文件到 `.cursor/rules/` 目录：

通用规则：
- user-base-rule.mdc
- git-automation.mdc
- ui-design-reconstruction.mdc
- project-rules-auto-management.mdc

项目规则：
- {项目规则文件名}.mdc

所有规则已生效，可以开始使用。
```

## 错误处理

### 本地文件不存在

- **症状**：本地缓存中找不到规则文件
- **处理**：自动切换到 GitHub 拉取
- **继续执行**：不影响其他文件的拉取

### GitHub 拉取失败

- **症状**：无法连接到 GitHub 或请求超时
- **处理**：
  - 提示用户检查网络连接
  - 询问是否重试
  - 如果用户选择重试，重新执行失败的请求
  - 如果用户选择跳过，继续处理其他文件

### 文件格式错误

- **症状**：文件内容不完整或格式不正确
- **处理**：
  - 自动修复（添加 frontmatter）
  - 如果无法修复，跳过该文件并记录日志
- **继续执行**：继续处理其他文件

### 项目类型无法识别

- **症状**：无法自动检测项目类型，用户也未指定
- **处理**：
  - 提示用户明确指定项目类型
  - 或询问用户是否需要创建通用规则模板

## 使用示例

### 示例 1：自动触发

```
用户：打开新项目
AI：检测到这是一个 Flutter 项目，是否导入 Flutter 项目规则？
用户：是
AI：✅ 已成功导入规则文件...
```

### 示例 2：手动触发

```
用户：帮我导入规则
AI：检测到这是一个 Android 项目，正在导入规则...
AI：✅ 已成功导入规则文件...
```

### 示例 3：指定项目类型

```
用户：这是一个 Python 项目，导入规则
AI：正在为 Python 项目导入规则...
AI：✅ 已成功导入规则文件...
```

### 示例 4：空白文件夹

```
用户：这是一个新的 Flutter 项目，导入规则
AI：正在为 Flutter 项目导入规则...
AI：✅ 已成功导入规则文件...
```

## 注意事项

1. **避免循环依赖**：`github-rules-sync.mdc` 不应被自动导入
2. **文件完整性**：所有规则文件必须包含 frontmatter
3. **错误恢复**：单个文件拉取失败不应影响其他文件的拉取
4. **本地缓存**：从 GitHub 拉取成功后更新本地缓存
5. **规则优先级**：项目规则 > 通用规则（项目特定规则优先）
