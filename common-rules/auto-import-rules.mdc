---
alwaysApply: true
---

# 规则自动导入

> 定义规则自动导入的完整流程，整合 GitHub 拉取和本地缓存逻辑，支持自动检测和手动触发

## 触发机制

### 自动触发

- **打开项目时**：检测到 `.cursor/rules/` 目录不存在或为空时，自动提示用户是否导入规则
- **提示模式**：自动检测项目类型后，提示用户确认是否导入规则

### 手动触发

支持以下自然语言指令：

**导入规则**：
- "导入规则"
- "帮我导入规则"
- "导入安卓规则" / "导入 Android 规则"
- "导入 Flutter 规则"
- "导入 Python 规则"
- "导入 PHP 规则"
- "这是 Flutter 项目，导入规则"
- "这是一个 Android 项目"

**更新规则**：
- "更新规则"
- "同步规则"
- "刷新规则"
- "重新导入规则"
- "更新项目规则"
- 当规则项目数据发生变化时，使用这些指令更新当前项目的规则文件

### 触发检测逻辑

1. **检查 `.cursor/rules/` 目录**
   - 如果目录不存在或为空，进入自动触发流程（导入规则）
   - 如果目录已存在且不为空：
     - 用户说"更新规则"、"同步规则"等 → 执行更新流程（包含冲突检测和管理）
     - 用户说"导入规则" → 执行导入流程（包含冲突检测和管理）
     - **无论哪种情况，都必须执行冲突检测，保护用户自定义规则和已修改的规则**

2. **识别用户指令**
   - **导入规则**：检测用户消息中是否包含"导入规则"、"导入 XXX 规则"等关键词
   - **更新规则**：检测用户消息中是否包含"更新规则"、"同步规则"、"刷新规则"等关键词
   - 检测用户是否明确指定项目类型

### 更新规则流程

当用户明确要求更新规则时，**必须执行冲突检测和管理流程**：

1. **执行冲突检测**（参考 `rules-conflict-management.mdc`）
   - 扫描 `.cursor/rules/` 目录中的所有规则文件
   - 识别文件类型：本项目规则、通用规则、用户自定义规则
   - **用户自定义规则文件绝对不触碰**

2. **检测规则文件是否被修改**
   - 对比规则库版本和项目版本（通过内容哈希或内容对比）
   - 识别哪些文件被用户修改过

3. **生成冲突报告**
   - 展示详细的冲突检测报告
   - 分类显示：用户自定义规则（保护）、未修改的文件、已修改的文件

4. **处理未修改的文件**
   - 直接更新未修改的文件（不需要询问）
   - 从规则库拉取最新版本覆盖

5. **处理已修改的文件（需要用户确认）**
   - 为每个已修改的文件询问用户处理方式：
     * **选项 A：覆盖还原** - 放弃用户修改，恢复到规则库最新版本
     * **选项 B：保留用户版本** - 保留用户修改，不更新该文件
     * **选项 C：智能合并** - 在用户修改基础上，合并规则库的更新内容
   - 等待用户选择后再执行

6. **执行智能合并（如果用户选择）**
   - 以用户版本为基础
   - 合并规则库的新增和更新内容
   - 生成合并报告并展示给用户确认
   - 用户确认后才保存合并后的文件

7. **完成提示**
   - 显示最终处理结果
   - 说明哪些文件已更新、哪些已保留、哪些已合并
   - 明确说明用户自定义规则文件未被触碰

**注意**：即使用户明确要求"更新规则"，也不能直接覆盖已修改的文件，必须询问用户确认。

## 项目类型识别

### 自动检测

按以下优先级自动检测项目类型：

1. **Flutter 混合项目**
   - 检测条件：存在 `pubspec.yaml` 且存在 `android/` 目录
   - 规则文件：`android-flutter-project.mdc`

2. **Flutter 项目**
   - 检测条件：存在 `pubspec.yaml`
   - 规则文件：`flutter-project.mdc`

3. **Android 项目**
   - 检测条件：存在 `settings.gradle` 或根目录 `build.gradle`，且不存在 `pubspec.yaml`
   - 规则文件：`android-project.mdc`

4. **Python 项目**
   - 检测条件：存在 `requirements.txt` 或 `pyproject.toml`
   - 规则文件：`python-project.mdc`

5. **PHP 项目**
   - 检测条件：存在 `composer.json`
   - 规则文件：`php-project.mdc`

6. **Kotlin 项目**
   - 检测条件：主要代码文件为 `.kt` 文件
   - 规则文件：`kotlin-project.mdc`

7. **Java 项目**
   - 检测条件：主要代码文件为 `.java` 文件
   - 规则文件：`java-project.mdc`

### 用户指定

如果用户明确说明项目类型（如"这是 Flutter 项目"），优先使用用户指定的类型，忽略自动检测结果。

## 规则来源选择

### 默认配置

- **本地缓存路径**：`C:\Users\Administrator\Desktop\cursor-rules`
- **GitHub 仓库**：`https://github.com/yfcyfc123234/cursor-rules`
- **默认分支**：`main`
- **Raw Content URL**：`https://raw.githubusercontent.com/yfcyfc123234/cursor-rules/main/`

### 配置检测和用户提示

在执行规则导入前，需要检测配置是否可用：

1. **检测本地缓存路径**
   - 检查默认本地缓存路径是否存在
   - 如果路径不存在或无法访问：
     - 提示用户："⚠️ 本地缓存路径不存在或无法访问：`C:\Users\Administrator\Desktop\cursor-rules`"
     - 询问用户："请输入正确的本地缓存路径，或按 Enter 跳过本地缓存（将仅从 GitHub 拉取）"
     - 验证用户输入的路径是否有效
     - 如果用户跳过，仅使用 GitHub 作为规则来源

2. **检测 GitHub 仓库**
   - 尝试访问默认 GitHub 仓库
   - 如果访问失败（网络错误、仓库不存在等）：
     - 提示用户："⚠️ 无法访问 GitHub 仓库：`https://github.com/yfcyfc123234/cursor-rules`"
     - 询问用户："请输入正确的 GitHub 仓库地址（格式：owner/repo 或完整 URL），或按 Enter 跳过 GitHub（将仅使用本地缓存）"
     - 验证用户输入的仓库地址格式：
       - 支持格式：`owner/repo` 或 `https://github.com/owner/repo`
       - 验证仓库是否为公开仓库
     - 如果用户跳过，仅使用本地缓存作为规则来源

3. **配置验证和降级策略**
   - 如果两者都不可用，执行降级策略：
     - 尝试从默认 GitHub 仓库（`https://github.com/yfcyfc123234/cursor-rules`）下载规则文件到本地缓存
     - 如果用户提供了本地缓存路径（即使路径不存在），尝试创建目录并下载文件
     - 如果用户未提供本地缓存路径，使用默认路径并尝试创建目录
     - 下载成功后，使用本地缓存继续执行规则导入
     - 如果下载失败，友好提示用户并放弃操作

### 优先级策略

1. **优先从本地缓存拉取**
   - 如果本地缓存路径可用，优先使用本地文件
   - 如果本地存在规则文件，直接使用本地文件

2. **GitHub 作为备用**
   - 如果本地不存在或本地缓存不可用，从 GitHub 拉取
   - 如果 GitHub 仓库可用，从 GitHub 拉取

3. **自动更新缓存**
   - 从 GitHub 拉取成功后，自动更新本地缓存（如果本地缓存路径可用）
   - 确保本地缓存与 GitHub 仓库同步

4. **降级策略：自动下载到本地缓存**
   - 当用户既没有本地缓存，也没有提供 GitHub 地址时：
     - 尝试从默认 GitHub 仓库（`https://github.com/yfcyfc123234/cursor-rules`）下载规则文件
     - 下载到用户指定的本地缓存路径（如果用户提供了路径）
     - 如果用户未提供路径，使用默认路径：`C:\Users\Administrator\Desktop\cursor-rules`
     - 如果路径不存在，尝试创建目录
     - 下载所有通用规则和项目规则文件
     - 如果下载成功，使用本地缓存继续执行
     - 如果下载失败（网络错误、权限问题等），友好提示用户并放弃操作

## 规则文件导入流程

### 步骤 1：拉取通用规则

从 `common-rules/` 目录拉取以下文件（排除 `github-rules-sync.mdc`）：

- `user-base-rule.mdc` - 用户基础规则
- `git-automation.mdc` - Git 自动化规则
- `auto-import-rules.mdc` - 规则自动导入规则（本文件）
- `ui-design-reconstruction.mdc` - UI 设计图还原规则
- `project-rules-auto-management.mdc` - 项目规则管理规则
- `batch-file-operations.mdc` - 批量文件操作优化规则

**排除文件**：`github-rules-sync.mdc`（避免循环拉取）

### 步骤 2：拉取项目规则

根据项目类型匹配对应的项目规则文件：

- Flutter 混合项目 → `android-flutter-project.mdc`
- Flutter 项目 → `flutter-project.mdc`
- Android 项目 → `android-project.mdc`
- Python 项目 → `python-project.mdc`
- PHP 项目 → `php-project.mdc`
- Kotlin 项目 → `kotlin-project.mdc`
- Java 项目 → `java-project.mdc`

### 步骤 3：验证文件格式

1. **检查 frontmatter**
   - 所有规则文件必须包含 frontmatter：
     ```markdown
     ---
     alwaysApply: true
     ---
     ```

2. **自动修复**
   - 如果文件缺少 frontmatter，自动添加
   - 确保文件格式正确

### 步骤 4：处理文件名冲突

1. **通用规则文件**
   - 保持原文件名（如 `user-base-rule.mdc`）

2. **项目规则文件**
   - 使用描述性名称，基于项目类型：
     - Flutter 混合项目 → `android-flutter-rules.mdc`
     - Flutter 项目 → `flutter-rules.mdc`
     - Android 项目 → `android-rules.mdc`
     - Python 项目 → `python-rules.mdc`
     - PHP 项目 → `php-rules.mdc`
     - Kotlin 项目 → `kotlin-rules.mdc`
     - Java 项目 → `java-rules.mdc`

3. **冲突处理**
   - 检查 `.cursor/rules/` 目录中是否已存在同名文件
   - 如果存在，使用递增后缀：
     - 如果已有 `android-rules.mdc`，使用 `android-rules2.mdc`
     - 如果已有 `android-rules.mdc` 和 `android-rules2.mdc`，使用 `android-rules3.mdc`
     - 依此类推

### 步骤 5：保存到项目

1. **创建目录**
   - 在项目根目录创建 `.cursor/rules/` 目录（如果不存在）

2. **保存文件**
   - 将所有成功拉取的文件保存到 `.cursor/rules/` 目录
   - 使用确定的文件名
   - 确保文件内容完整，包含 frontmatter

3. **验证保存结果**
   - 检查文件是否成功保存
   - 验证文件内容是否正确

### 步骤 6：完成提示

成功导入所有规则文件后，提示用户：

```
✅ 已成功导入规则文件到 `.cursor/rules/` 目录：

通用规则：
- user-base-rule.mdc
- git-automation.mdc
- ui-design-reconstruction.mdc
- project-rules-auto-management.mdc

项目规则：
- {项目规则文件名}.mdc

所有规则已生效，可以开始使用。
```

## 错误处理

### 本地文件不存在

- **症状**：本地缓存中找不到规则文件
- **处理**：自动切换到 GitHub 拉取
- **继续执行**：不影响其他文件的拉取

### GitHub 拉取失败

- **症状**：无法连接到 GitHub 或请求超时
- **处理**：
  - 提示用户检查网络连接
  - 询问是否重试
  - 如果用户选择重试，重新执行失败的请求
  - 如果用户选择跳过，继续处理其他文件

### 文件格式错误

- **症状**：文件内容不完整或格式不正确
- **处理**：
  - 自动修复（添加 frontmatter）
  - 如果无法修复，跳过该文件并记录日志
- **继续执行**：继续处理其他文件

### 项目类型无法识别

- **症状**：无法自动检测项目类型，用户也未指定
- **处理**：
  - 提示用户明确指定项目类型
  - 或询问用户是否需要创建通用规则模板

### 配置缺失或无效

- **症状**：本地缓存路径不存在，GitHub 仓库无法访问
- **处理流程**：
  
  1. **尝试降级策略**：
     - 提示用户："⚠️ 无法找到可用的规则来源，正在尝试从默认 GitHub 仓库下载规则文件到本地缓存..."
     - 使用默认 GitHub 仓库：`https://github.com/yfcyfc123234/cursor-rules`
     - 确定本地缓存路径：
       - 如果用户之前提供了路径（即使不存在），使用该路径
       - 如果用户未提供路径，使用默认路径：`C:\Users\Administrator\Desktop\cursor-rules`
     - 尝试创建目录结构（包括 `common-rules/` 子目录）
     - 从默认 GitHub 仓库下载所有规则文件到本地缓存
  
  2. **下载成功**：
     - 提示用户："✅ 已成功从默认 GitHub 仓库下载规则文件到本地缓存：`{路径}`"
     - 显示下载的文件列表
     - 使用本地缓存继续执行规则导入流程
  
  3. **下载失败**：
     - 友好提示用户："❌ 无法从默认 GitHub 仓库下载规则文件"
     - 说明可能的原因：
       - 网络连接问题
       - 权限不足（无法创建目录或写入文件）
       - GitHub 仓库暂时不可访问
     - 提供建议：
       - 检查网络连接
       - 检查目录权限
       - 稍后重试
       - 或手动配置本地缓存路径或 GitHub 仓库地址
     - 放弃操作，不继续执行规则导入

## 使用示例

### 示例 1：自动触发

```
用户：打开新项目
AI：检测到这是一个 Flutter 项目，是否导入 Flutter 项目规则？
用户：是
AI：✅ 已成功导入规则文件...
```

### 示例 2：手动触发

```
用户：帮我导入规则
AI：检测到这是一个 Android 项目，正在导入规则...
AI：✅ 已成功导入规则文件...
```

### 示例 3：指定项目类型

```
用户：这是一个 Python 项目，导入规则
AI：正在为 Python 项目导入规则...
AI：✅ 已成功导入规则文件...
```

### 示例 4：空白文件夹

```
用户：这是一个新的 Flutter 项目，导入规则
AI：正在为 Flutter 项目导入规则...
AI：✅ 已成功导入规则文件...
```

### 示例 5：配置不可用时的处理

```
用户：帮我导入规则
AI：检测到这是一个 Flutter 项目，正在检查配置...
AI：⚠️ 本地缓存路径不存在或无法访问：`C:\Users\Administrator\Desktop\cursor-rules`
AI：请输入正确的本地缓存路径，或按 Enter 跳过本地缓存（将仅从 GitHub 拉取）
用户：D:\MyRules\cursor-rules
AI：验证路径中...
AI：✅ 路径有效，将使用 D:\MyRules\cursor-rules 作为本地缓存
AI：正在导入规则...
AI：✅ 已成功导入规则文件
```

### 示例 6：GitHub 仓库不可用时的处理

```
用户：帮我导入规则
AI：检测到这是一个 Flutter 项目，正在检查配置...
AI：⚠️ 无法访问 GitHub 仓库：`https://github.com/yfcyfc123234/cursor-rules`
AI：请输入正确的 GitHub 仓库地址（格式：owner/repo 或完整 URL），或按 Enter 跳过 GitHub
用户：myusername/my-cursor-rules
AI：验证仓库中...
AI：✅ 仓库有效，将使用 https://github.com/myusername/my-cursor-rules
AI：正在导入规则...
AI：✅ 已成功导入规则文件
```

### 示例 7：降级策略 - 自动下载到本地缓存

```
用户：帮我导入规则
AI：检测到这是一个 Flutter 项目，正在检查配置...
AI：⚠️ 本地缓存路径不存在或无法访问：`C:\Users\Administrator\Desktop\cursor-rules`
AI：请输入正确的本地缓存路径，或按 Enter 跳过本地缓存
用户：[按 Enter 跳过]
AI：⚠️ 无法找到可用的规则来源，正在尝试从默认 GitHub 仓库下载规则文件到本地缓存...
AI：正在创建目录：C:\Users\Administrator\Desktop\cursor-rules\common-rules\
AI：正在下载规则文件...
AI：✅ 已成功从默认 GitHub 仓库下载规则文件到本地缓存
AI：正在导入规则...
AI：✅ 已成功导入规则文件
```

### 示例 8：降级策略失败时的处理

```
用户：帮我导入规则
AI：检测到这是一个 Flutter 项目，正在检查配置...
AI：⚠️ 无法找到可用的规则来源，正在尝试从默认 GitHub 仓库下载规则文件到本地缓存...
AI：正在创建目录...
AI：❌ 权限不足，无法创建目录或写入文件到：`C:\Users\Administrator\Desktop\cursor-rules`
AI：建议：
  - 检查目录权限
  - 使用管理员权限运行
  - 或选择其他可写的路径
AI：无法继续执行规则导入，请解决权限问题后重试
```

## 注意事项

1. **避免循环依赖**：`github-rules-sync.mdc` 不应被自动导入
2. **文件完整性**：所有规则文件必须包含 frontmatter
3. **错误恢复**：单个文件拉取失败不应影响其他文件的拉取
4. **本地缓存**：从 GitHub 拉取成功后更新本地缓存
5. **规则优先级**：项目规则 > 通用规则（项目特定规则优先）
